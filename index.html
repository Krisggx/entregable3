<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Matemáticas - PDFs</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZUsv1BvwSmyhWxkOyvxBEjhia-cbcmm8",
            authDomain: "gestor-pdf-2025.firebaseapp.com",
            projectId: "gestor-pdf-2025",
            storageBucket: "gestor-pdf-2025.firebasestorage.app",
            messagingSenderId: "897752284018",
            appId: "1:897752284018:web:be86e946c73f1861727beb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let pdfs = [];
        let isAdmin = false;
        let editingId = null;
        const ADMIN_PASSWORD = "admin2025";

        const CATEGORIAS = [
            { nombre: "Todos", color: "#8e8e93" },
            { nombre: "Álgebra", color: "#ff375f" },
            { nombre: "Geometría", color: "#ff9f0a" },
            { nombre: "Cálculo", color: "#00d46a" },
            { nombre: "Estadística", color: "#007aff" },
            { nombre: "Probabilidad", color: "#af52de" },
            { nombre: "Álgebra Lineal", color: "#ff2d92" },
            { nombre: "Trigonometría", color: "#32d74b" },
            { nombre: "Matemática Discreta", color: "#64d2ff" },
            { nombre: "Otros", color: "#8e8e93" }
        ];

        let categoriaActual = "Todos";
        let busquedaActual = "";

        const q = query(collection(db, "pdfs"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            pdfs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPdfs();
            renderFiltrosCategorias();
        });

        function getColorCategoria(cat) {
            const found = CATEGORIAS.find(c => c.nombre === cat);
            return found ? found.color : "#8e8e93";
        }

        function getPdfsFiltrados() {
            return pdfs.filter(pdf => {
                const coincideCategoria = categoriaActual === "Todos" || pdf.categoria === categoriaActual;
                const texto = `${pdf.title} ${pdf.description || ''}`.toLowerCase();
                const coincideBusqueda = texto.includes(busquedaActual.toLowerCase());
                return coincideCategoria && coincideBusqueda;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function renderPdfs() {
            const list = document.getElementById('pdfList');
            const empty = document.getElementById('emptyState');
            const pdfsFiltrados = getPdfsFiltrados();

            if (pdfsFiltrados.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('p').textContent = pdfs.length === 0 
                    ? 'No hay documentos disponibles' 
                    : 'No se encontraron documentos con los filtros actuales';
                return;
            }
            empty.style.display = 'none';

            list.innerHTML = pdfsFiltrados.map(pdf => `
                <div class="pdf-card">
                    <div class="pdf-preview">
                        <embed src="${pdf.fileUrl}#toolbar=0&navpanes=0&scrollbar=1&view=FitH" type="application/pdf">
                    </div>
                    <div class="pdf-info">
                        <div class="pdf-title">${escapeHtml(pdf.title)}</div>
                        ${pdf.categoria ? `<div class="pdf-categoria" style="background:${getColorCategoria(pdf.categoria)}">${escapeHtml(pdf.categoria)}</div>` : ''}
                        <div class="pdf-description">${escapeHtml(pdf.description || '')}</div>
                        <div class="pdf-actions">
                            <button class="btn btn-primary" onclick="window.open('${pdf.fileUrl}', '_blank')">Abrir PDF</button>
                            ${isAdmin ? `
                                <button class="btn btn-success" onclick="editPdf('${pdf.id}', '${escapeHtml(pdf.title)}', '${escapeHtml(pdf.description || '')}', '${escapeHtml(pdf.fileName || '')}', '${escapeHtml(pdf.categoria || '')}')">
                                    Editar
                                </button>
                                <button class="btn btn-danger" onclick="deletePdf('${pdf.id}', '${pdf.fileUrl}')">
                                    Eliminar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderFiltrosCategorias() {
            const container = document.getElementById('categoriaFilters');
            container.innerHTML = CATEGORIAS.map(cat => `
                <button class="filter-btn ${categoriaActual === cat.nombre ? 'active' : ''}" 
                        style="background:${categoriaActual === cat.nombre ? cat.color : 'rgba(0,0,0,0.05)'}; 
                               color:${categoriaActual === cat.nombre ? 'white' : 'var(--text-primary)'}"
                        onclick="filtrarPorCategoria('${cat.nombre}')">
                    ${cat.nombre}
                </button>
            `).join('');
        }

        window.filtrarPorCategoria = function(cat) {
            categoriaActual = cat;
            renderFiltrosCategorias();
            renderPdfs();
        };

        window.buscar = function() {
            busquedaActual = document.getElementById('searchInput').value.trim();
            renderPdfs();
        };

        window.login = function() {
            const pass = document.getElementById('password').value;
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('addPdfBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('userBadge').innerHTML = '<span class="admin-badge">Administrador</span>';
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('password').value = '';
                renderPdfs();
            } else {
                alert('Contraseña incorrecta');
            }
        };

        window.logout = function() {
            isAdmin = false;
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('addPdfBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userBadge').innerHTML = '';
            renderPdfs();
        };

        window.openModal = function() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Agregar Documento PDF';
            document.getElementById('pdfForm').reset();
            document.getElementById('fileLabel').textContent = 'Seleccionar archivo PDF';
            document.getElementById('pdfFile').required = true;
            document.getElementById('pdfCategoria').value = 'Álgebra';
            document.getElementById('pdfModal').classList.add('active');
        };

        window.editPdf = function(id, title, desc, fileName, categoria) {
            editingId = id;
            document.getElementById('modalTitle').textContent = 'Editar Documento PDF';
            document.getElementById('pdfTitle').value = title;
            document.getElementById('pdfDescription').value = desc || '';
            document.getElementById('pdfCategoria').value = categoria || 'Otros';
            document.getElementById('fileLabel').textContent = fileName ? `Archivo actual: ${fileName}` : 'Seleccionar nuevo PDF';
            document.getElementById('pdfFile').required = false;
            document.getElementById('pdfModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('pdfModal').classList.remove('active');
            editingId = null;
        };

        window.deletePdf = async function(id, fileUrl) {
            if (!confirm('¿Eliminar este PDF permanentemente?')) return;
            try {
                if (fileUrl) {
                    const fileRef = ref(storage, fileUrl);
                    await deleteObject(fileRef).catch(() => {});
                }
                await deleteDoc(doc(db, "pdfs", id));
                alert('PDF eliminado correctamente');
            } catch (e) {
                console.error(e);
                alert('Error al eliminar: ' + e.message);
            }
        };

        window.savePdf = async function(e) {
            e.preventDefault();
            const title = document.getElementById('pdfTitle').value.trim();
            const description = document.getElementById('pdfDescription').value.trim();
            const categoria = document.getElementById('pdfCategoria').value;
            const fileInput = document.getElementById('pdfFile');

            if (!title) return alert('El título es obligatorio');
            if (!fileInput.files[0] && !editingId) return alert('Selecciona un PDF');
            if (!isAdmin) return alert('Debes ser administrador');

            try {
                let fileUrl = editingId ? pdfs.find(p => p.id === editingId)?.fileUrl : null;
                let fileName = editingId ? pdfs.find(p => p.id === editingId)?.fileName : null;

                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (!file.type.includes('pdf')) return alert('Solo archivos PDF');

                    if (editingId && fileUrl) {
                        try { await deleteObject(ref(storage, fileUrl)); } catch(e) {}
                    }

                    const storageRef = ref(storage, `pdfs/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(snapshot.ref);
                    fileName = file.name;
                }

                const pdfData = {
                    title,
                    description: description || '',
                    categoria,
                    fileUrl,
                    fileName,
                    updatedAt: serverTimestamp()
                };

                if (editingId) {
                    await updateDoc(doc(db, "pdfs", editingId), pdfData);
                    alert('PDF actualizado');
                } else {
                    pdfData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "pdfs"), pdfData);
                    alert('PDF subido correctamente');
                }

                closeModal();
            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            }
        };

        window.showLoginModal = () => document.getElementById('loginModal').classList.add('active');
        window.closeLoginModal = () => {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('password').value = '';
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pdfFile').addEventListener('change', function() {
                if (this.files[0]) {
                    document.getElementById('fileLabel').textContent = this.files[0].name;
                }
            });
        });
    </script>

    <style>
        :root {
            --bg-primary: #f5f5f7;
            --bg-card: rgba(255,255,255,0.65);
            --bg-card-hover: rgba(255,255,255,0.85);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent: #0071e3;
            --danger: #ff453a;
            --success: #30d158;
            --border: rgba(0,0,0,0.08);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000;
                --bg-card: rgba(28,28,30,0.7);
                --bg-card-hover: rgba(44,44,46,0.9);
                --text-primary: #f5f5f7;
                --text-secondary: #8e8e93;
                --border: rgba(255,255,255,0.1);
            }
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system,system-ui,'SF Pro Display',sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; padding:20px; }
        .container { max-width:1280px; margin:0 auto; padding:0 20px; }
        header { background:var(--bg-card); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:18px; padding:20px 32px; margin-bottom:24px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px; box-shadow:0 4px 20px rgba(0,0,0,0.05); }
        h1 { font-size:32px; font-weight:700; }
        .btn { padding:10px 18px; border:none; border-radius:12px; font-size:15px; font-weight:600; cursor:pointer; transition:all .25s; }
        .btn-primary { background:var(--accent); color:white; }
        .btn-success { background:var(--success); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-secondary { background:transparent; color:var(--accent); border:1px solid var(--accent); }
        .btn:hover { transform:translateY(-2px); }

        .search-input { width:100%; padding:14px 18px; border:1px solid var(--border); border-radius:12px; font-size:16px; background:rgba(255,255,255,0.7); margin:20px 0; }
        .search-input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,113,227,0.15); }

        .filter-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; overflow-x:auto; padding:8px 0; }
        .filter-btn { padding:8px 16px; border:none; border-radius:20px; font-weight:600; cursor:pointer; white-space:nowrap; transition:.2s; }

        .pdf-categoria { color:white !important; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; display:inline-block; margin:8px 0; }

        .content { background:var(--bg-card); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:20px; padding:40px; }
        .pdf-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:32px; }
        .pdf-card { background:var(--bg-card); border:1px solid var(--border); border-radius:20px; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,0.06); transition:.4s; }
        .pdf-card:hover { transform:translateY(-10px); box-shadow:0 24px 48px rgba(0,0,0,0.18); }
        .pdf-preview { height:440px; background:#fff; }
        .pdf-preview embed { width:100%; height:100%; }
        .pdf-info { padding:24px; }
        .pdf-title { font-size:22px; font-weight:600; margin-bottom:8px; }
        .pdf-description { color:var(--text-secondary); margin-bottom:16px; }
        .pdf-actions { display:flex; gap:10px; flex-wrap:wrap; }
        .pdf-actions .btn { flex:1; padding:12px; font-size:14px; }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(12px); align-items:center; justify-content:center; z-index:1000; padding:20px; }
        .modal.active { display:flex; }
        .modal-content { background:var(--bg-card); border-radius:20px; max-width:540px; width:100%; border:1px solid var(--border); box-shadow:0 25px 50px rgba(0,0,0,0.25); overflow:hidden; }
        .modal-header { padding:24px 32px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); }
        .modal-header h2 { font-size:24px; font-weight:600; }
        .close-btn { font-size:32px; background:none; border:none; color:var(--text-secondary); cursor:pointer; width:40px; height:40px; border-radius:50%; }
        .close-btn:hover { background:rgba(0,0,0,0.08); }
        .modal-body { padding:32px; }
        .form-group { margin-bottom:24px; }
        .form-group label { display:block; margin-bottom:8px; font-weight:600; }
        input, textarea, select { width:100%; padding:14px 16px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.6); font-size:16px; }
        select { cursor:pointer; }
        textarea { min-height:80px; resize:vertical; }
        .file-input-label { display:block; padding:40px; border:2px dashed var(--border); border-radius:14px; text-align:center; cursor:pointer; background:rgba(0,0,0,0.03); transition:.3s; }
        .file-input-label:hover { border-color:var(--accent); background:rgba(0,113,227,0.05); }
        .modal-footer { padding:0 32px 32px; display:flex; gap:14px; }
        .empty-state { text-align:center; padding:100px 20px; color:var(--text-secondary); }
        .admin-badge { background:#ff9f0a; color:white; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; margin-left:12px; }
        @media (max-width:768px) { .pdf-grid { grid-template-columns:1fr; } .pdf-preview { height:380px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Repositorio de PDFs - Matemáticas</h1>
                <span id="userBadge"></span>
            </div>
            <div>
                <button id="loginBtn" class="btn btn-primary" onclick="showLoginModal()">Acceso Admin</button>
                <button id="addPdfBtn" class="btn btn-primary" style="display:none;" onclick="openModal()">Agregar PDF</button>
                <button id="logoutBtn" class="btn btn-secondary" style="margin-left:12px;display:none;" onclick="logout()">Salir</button>
            </div>
        </header>

        <div class="content">
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por título o descripción..." onkeyup="buscar()">

            <div class="filter-bar" id="categoriaFilters"></div>

            <div id="pdfList" class="pdf-grid"></div>

            <div id="emptyState" class="empty-state">
                <h3>No hay documentos disponibles</h3>
                <p>Inicia sesión como administrador para subir PDFs</p>
            </div>
        </div>
    </div>

    <!-- Modal Login -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Acceso Administrador</h2>
                <button class="close-btn" onclick="closeLoginModal()">x</button>
            </div>
            <div class="modal-body">
                <form onsubmit="event.preventDefault(); login();">
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%;padding:15px;">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Agregar Documento PDF</h2>
                <button class="close-btn" onclick="closeModal()">x</button>
            </div>
            <div class="modal-body">
                <form id="pdfForm" onsubmit="savePdf(event)">
                    <div class="form-group">
                        <label>Título *</label>
                        <input type="text" id="pdfTitle" required placeholder="Ej: Integrales por partes">
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="pdfCategoria">
                            <option value="Álgebra">Álgebra</option>
                            <option value="Geometría">Geometría</option>
                            <option value="Cálculo">Cálculo</option>
                            <option value="Estadística">Estadística</option>
                            <option value="Probabilidad">Probabilidad</option>
                            <option value="Álgebra Lineal">Álgebra Lineal</option>
                            <option value="Trigonometría">Trigonometría</option>
                            <option value="Matemática Discreta">Matemática Discreta</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripción (opcional)</label>
                        <textarea id="pdfDescription" placeholder="Ej: Apuntes del tema 7"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Archivo PDF ${editingId ? '(opcional si no cambias)' : '*'}</label>
                        <input type="file" id="pdfFile" accept=".pdf" style="display:none;">
                        <label for="pdfFile" class="file-input-label">
                            <div style="font-size:48px;margin-bottom:12px;">PDF</div>
                            <span id="fileLabel">Seleccionar archivo PDF</span>
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success" style="flex:1;padding:15px;">Guardar</button>
                        <button type="button" class="btn btn-secondary" style="flex:1;padding:15px;" onclick="closeModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
